// touch组件
function VueTouch(el,binding,type){var g=this;g.obj=el;g.binding=binding;g.touchType=type;g.firstTouchPosition={x:0,y:0};g.firstTouchTime=0;g.callBack=typeof(binding.value)==="object"?binding.value.fn:binding.value;g.moved=false;g.leaved=false;g.longTouched=false;var _listener=Object.create(null);var _listen=(type)=>{return function(e){var{stop,prevent,self,once}=g.binding.modifiers;if(stop)e.stopPropagation();if(prevent)e.preventDefault();if(once)g.obj.removeEventListener("touch"+type,_listener[type]);if(self&&e.target!==e.currentTarget)return;g[type](e)}};_listener.start=_listen('start');_listener.end=_listen('end');_listener.move=_listen('move');this.obj.addEventListener("touchstart",_listener.start,false);this.obj.addEventListener("touchend",_listener.end,false);this.obj.addEventListener("touchmove",_listener.move,false)};VueTouch.prototype={start:function(e){this.d=20;var g=this;g.moved=false;g.leaved=false;g.longTouched=false;g.firstTouchPosition=g.getMultiCenter(e.changedTouches);g.firstTouchTime=e.timeStamp;g.time=setTimeout(function(){if(!g.leaved&&!g.moved){g.touchType==="longtap"&&g.callBack(e,g.binding.value);g.longTouched=true}}.bind(g),1000)},end:function(e){var g=this;var{x,y}=g.getMultiCenter(e.changedTouches);var _disX=x-g.firstTouchPosition.x;var _disY=y-g.firstTouchPosition.y;var _dis=Math.sqrt(_disX*_disX+_disY*_disY);var _timeDis=e.timeStamp-g.firstTouchTime;clearTimeout(g.time);var _angle=this.getAngle(_disX,_disY);if(_dis>20&&_timeDis<300){g.touchType==="swipe"&&g.callBack(e,g.binding.value);if(_angle>=60&&_angle<=120)g.touchType==="swipedown"&&g.callBack(e,g.binding.value);if(_angle<=-60&&_angle>=-120)g.touchType==="swipeup"&&g.callBack(e,g.binding.value);if(_angle<=10&&_angle>=-10)g.touchType==="swiperight"&&g.callBack(e,g.binding.value);if((_angle<=-160&&_angle>-180)||(_angle>=160&&_angle<=180))g.touchType==="swipeleft"&&g.callBack(e,g.binding.value)}else{if(!g.longTouched&&!g.moved){g.touchType==="tap"&&g.callBack(e,g.binding.value);g.leaved=true}}},move:function(e){this.moved=true},getMultiCenter:function(touches){var g=this,x=0,y=0;const _length=touches.length;for(var i=0;i<_length;i++){x+=touches[i].pageX;y+=touches[i].pageY}return{x:Math.round(x/_length),y:Math.round(y/_length)}},getAngle:function(disX,disY){var g=this;if(typeof disX!=='number'||typeof disY!=='number')return 45;return Math.atan2(disY,disX)*180/Math.PI}};var eArr=['tap','swipe','swipeleft','swiperight','swipedown','swipeup','longtap'];eArr.forEach(function(s){Vue.directive(s,{bind:function(el,binding){new VueTouch(el,binding,s)}})});

// 音频播放组件
function playAudio(src){var $player=$('.nft-player');var $progressBar=$player.find('.nft-player-progress i');var $progressRange=$player.find('.nft-player-progress input[type=range]');var $playBtn=$player.find('.nft-player-play');var $stopBtn=$player.find('.nft-player-stop');var $currTime=$player.find('[data-curr]');var $duration=$player.find('[data-duration]');var timer=function(callback){var _timer;return{start:function(){if(_timer){return}_timer=setInterval(callback,1000)},stop:function(){clearInterval(_timer);_timer=null}}};var nAudio=new Audio();var miniPlayer={init:function(){this.onDrag=false;nAudio.src=src;nAudio.id='audio';nAudio.loop=false;this.timer=timer($.proxy(this.updatePos,this));setTimeout(()=>{this.bindEvents();this.timer.start();$playBtn.triggerHandler('click')},100)},bindEvents:function(){var self=this;nAudio.addEventListener("playing",function(e){$playBtn.addClass('nft-player-pause')});nAudio.addEventListener("ended",function(){self.stop()});$progressRange.on('touchstart',function(e){self.onDrag=true;var touches=e.originalEvent.touches;if(touches.length>0){var x=touches[0].clientX;var percent=(x-$(this).offset().left)/this.clientWidth*100;self.updateProgressBar(percent,true)}}).on('touchmove',function(){self.onDrag=true;self.updateProgressBar(this.value,false)}).on('touchend',function(){self.onDrag=false;self.setProgress(this.value,false)});$playBtn.on('click',function(){if($(this).hasClass('nft-player-pause')){self.pause()}else{self.play()}});$stopBtn.on('click',function(){self.stop()})},updateProgressBar:function(percent,withRange){this.progress=percent;$progressBar.width(percent+'%');if(withRange){$progressRange.val(percent)}},setProgress:function(percent,withRange){if(this.duration===0){percent=0;withRange=true}this._currTime=(this.duration*percent/100)||0;this.currTime=this.formatTime(this._currTime);$currTime.text(this.currTime);this.updateProgressBar(percent,withRange);this.setCurrTime()},setCurrTime:function(){nAudio.currentTime=this._currTime},pause:function(){$playBtn.removeClass('nft-player-pause');nAudio.pause();this.timer.stop()},play:function(){nAudio.play();this.timer.start()},stop:function(){this.setProgress(0,true);this.pause()},updatePos:function(){var i=nAudio.currentTime;var min=~~(i/60),sec=~~(i%60);this._currTime=i;this.currTime=this.formatTime(i);$currTime.text(this.currTime);var duration=nAudio.duration||0;if(this.duration!==duration){this.duration=duration;var _durationTime=this.formatTime(duration);$duration.text(_durationTime)}if(this.onDrag)return;var precent=this._currTime===0?0:Math.ceil(this._currTime/this.duration*100);this.updateProgressBar(precent,true)},formatTime:function(timestamp){var min=~~(timestamp/60),sec=~~(timestamp%60);return[(min<10?"0"+min:min),(sec<10?"0"+sec:sec)].join(":")}};miniPlayer.init();return nAudio}

// indexDB组件
var Salt={name:'foxue',version:1,db:null,table:'foxueTable'};var INDEXDB={openDB(name,version,table,callback){var request=window.indexedDB.open(name,version);request.onerror=function(e){};request.onsuccess=function(e){Salt.db=e.target.result;if(callback&&(typeof callback==='function')){callback(Salt.db)}};request.onupgradeneeded=function(e){var db=e.target.result;if(!db.objectStoreNames.contains(table)){db.createObjectStore(table,{keyPath:"id"})}}},setItem(key,val){INDEXDB.openDB(Salt.name,Salt.version,Salt.table,function(){try{var addData=[{id:key,value:val}];var transaction=Salt.db.transaction(Salt.table,'readwrite');var store=transaction.objectStore(Salt.table);for(var i=0;i<addData.length;i++){store.add(addData[i])}INDEXDB.closeDB()}catch(error){console.log(error)}})},getItem:function(val,back){INDEXDB.openDB(Salt.name,Salt.version,Salt.table,function(){var transaction=Salt.db.transaction(Salt.table,'readwrite');var store=transaction.objectStore(Salt.table);var request=store.get(val);request.onsuccess=function(e){if(back&&(typeof back==='function')){if(e.target.result){back(e.target.result.value)}else{back('')}INDEXDB.closeDB()}}})},putItem(key,value){INDEXDB.openDB(Salt.name,Salt.version,Salt.table,function(){var transaction=Salt.db.transaction(Salt.table,'readwrite');var store=transaction.objectStore(Salt.table);var request=store.get(key);request.onsuccess=function(e){try{var resultData=e.target.result;resultData.value=value;var resultInfo=store.put(resultData);resultInfo.onsuccess=function(e){if(e.type=='success'){INDEXDB.closeDB()}}}catch(error){INDEXDB.setItem(key,value)}}})},deleteItem(key){INDEXDB.openDB(Salt.name,Salt.version,Salt.table,function(){var transaction=Salt.db.transaction(Salt.table,'readwrite');var store=transaction.objectStore(Salt.table);var result=store.delete(key);result.onsuccess=function(e){if(e.type=='success'){INDEXDB.closeDB()}}})},clearTable(){INDEXDB.openDB(Salt.name,Salt.version,Salt.table,function(){var transaction=Salt.db.transaction(Salt.table,'readwrite');var store=transaction.objectStore(Salt.table);var result=store.clear();result.onsuccess=function(e){if(e.type=='success'){INDEXDB.closeDB()}}})},closeDB(){Salt.db.close()},};INDEXDB.openDB(Salt.name,Salt.version,Salt.table);
