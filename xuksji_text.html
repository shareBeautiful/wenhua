<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name=App-Config content="fullscreen=yes,useHistoryState=yes,transition=yes">
    <meta content=yes name=apple-mobile-web-app-capable>
    <meta name=‚Äùapple-touch-fullscreen‚Äù content=‚Äùyes‚Äù>
    <meta name="theme-color" content="#1a1a1a">
    <meta content="telephone=no,email=no" name=format-detection>
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name=viewport
        content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=yes,viewport-fit=cover">
    <title></title>
    <link rel="stylesheet" href="css/content.css">
    <style>
        .B1_text p {
            padding: 10px 0;
        }

        .B1_text .header {
            font-size: 18px;
            text-align: right;
        }
        #bodyBox {
            font-size: 26px;
        }

        #readOpt .header,
        #readOpt .footer {
            font-size: 18px;
        }
    </style>
</head>

<body>
    <div id="app" v-cloak :class="'bg'+theme" class="theme">
        <!-- ÁøªÈ°µ -->
        <!-- <template v-if="isPage">
            <div class="page-box up" @click="pageUp"></div>
            <div class="page-box down" @click="pageDown(1)"></div>
        </template> -->

        <!-- ÁõÆÂΩï -->
        <div id="menu" @dblclick.capture="clickHideMenu" v-swipeleft="clickHideMenu" class="list-group"
            :class="{'show-a': showMenu}">
            <div>
                <div class="search-box" v-if="len>15">
                    <input type="search" class="form-control search" @input="search" @keyup.enter="enterSearch"
                        v-model="word" placeholder="ÊêúÁ¥¢...">
                </div>
                <div>
                    <span class="list-group-item fz book" :class="{active: item.id==theme}"
                        v-for="(item, index) in themeL" @click="changeTheme(item)" :key="item.id">{{item.n}}</span>
                    <span class="list-group-item fz book" @click.capture="switchDark">
                        <i class="zhe"></i>
                        <input class="switch" type="checkbox" v-model='isDark'>Ë∑üÈöèÁ≥ªÁªü</span>
                </div>
                <div>
                    <span @click.capture="switchPage" class="list-group-item fz book"><i class="zhe"></i><input
                            class="switch" type="checkbox" v-model='isPage'>ÁøªÈ°µ</span>
                    <span @click.capture="switchOrder" class="list-group-item fz book"><i class="zhe"></i><input
                            class="switch" type="checkbox" v-model='isReverse'>ÂÄíÂ∫è</span>
                    <span class="list-group-item fz book" v-if="len>5">ÂÖ±:{{len}}Á´†</span>
                </div>
                <div class="list-group-item fz book curr-pos" @click="toTop">
                    <!-- {{subProcess}}- -->
                    ‰ΩçÁΩÆÔºö{{currIdx+1}}-{{currItem.title}}({{wordTotal}})
                </div>
                <!-- ÁõÆÂΩïÂàóË°® -->
                <div class="menu-item" v-for="(item, idx) in menuList" :key="item.id" v-show="!item.hide">
                    <a class="list-group-item " href="javascript:" @click="toArticle(item.idx);"
                        :class="['list-group-item-'+colors[idx%4],{active: item.idx===currIdx}]">
                        {{item.idx+1}}--{{item.title}}
                        <span v-if="item.total">({{item.total}})</span>
                    </a>
                </div>
                <!-- Â≠ó‰ΩìÂ§ßÂ∞èËÆæÁΩÆ -->
                <div>
                    <span class="list-group-item fz" :key="item" :class="{'active': item == currFontS}"
                        v-for="item in font" @click="setFontS(item)">{{item}}
                    </span>
                    <span class="list-group-item fz">ÂΩìÂâçÂ≠óÂè∑Ôºö{{ currFontS }}</span>
                </div>
                <!-- Â≠ó‰ΩìËÆæÁΩÆ -->
                <div>
                    <span class="list-group-item fz" :key="item" :class="{'active': item.v == currFontF}"
                        v-for="(item) in fontF" @click="setFontF(item)">{{item.n}}
                    </span>
                </div>
                <!--  -->
                <div>
                    <span class="list-group-item  fz" @click="setFontS('+')">+</span>
                    <span class="list-group-item fz" @click="setFontS('-')">-</span>
                </div>
            </div>
        </div>

        <!-- ÂÜÖÂÆπ -->
        <div id="bodyBox" v-show="articleD.html">
            <div class="panel-footer page-tap prev" @click.stop="pageNext('-')" v-if="currIdx-1>=0">
                ‰∏ä‰∏ÄÁ´† - {{subTit(menuList[currIdx-1]['title'])}}
                <span @click.stop="pageNext('+')" v-if="currIdx+1<len">‰∏ã‰∏ÄÁ´†</span>
            </div>
            <div class="body-box" @dblclick.capture="clickShowMenu()">
                <div :class="['panel','panel-'+colors[currIdx%4]]" @click.stop="showReadOpt()">
                    <div class="panel-heading">
                        <h3 class="panel-title text-center">
                            {{articleD.title}}
                            <!-- <span class="author">‰ΩúËÄÖÔºö</span> -->
                            <!-- <span class="author">({{item.total}})</span> -->
                        </h3>
                    </div>
                    <div class="panel-body" v-html="articleD.html"></div>
                    <div class="panel-footer">
                        ÂèëÂ∏ÉÊó∂Èó¥Ôºö{{articleD.date}}</div>
                </div>
            </div>
            <div class="panel-footer page-tap next" v-if="currIdx+1<len" @click.stop="pageNext('+')">
                ‰∏ã‰∏ÄÁ´† - {{menuList[currIdx+1]["title"]}}
            </div>
        </div>

        <!-- ËÆæÁΩÆ -->
        <div id="readOpt" @click.capture="hideReadOpt" @touchend="getP" :class="{active: showOpt}">
            <div class="header" v-if="currItem">
                <span class="h-l" @click="switchTheme">
                    <template v-if="theme == 4">üîÜ</template><template v-else>üåô</template>
                </span>
                {{subTit(currItem.title)}}
                <span class="h-r" @click="clickShowMenu()">ÁõÆÂΩï</span>
            </div>
            <div class="footer">
                <div class="f-item">
                    <span>Â≠óÔºö{{wordTotal}} -- ËøõÔºö{{process}}</span>
                </div>
                <!-- <span class="f-page">{{pageCurr}}/{{pageAll}}</span> -->
            </div>
        </div>
    </div>
</body>
<script src="js/comm.js"></script>
<script src="js/touch.js"></script>
<script>
    var id = $echo.getParams('id');
    new Vue({
        el: '#app',
        data: {
            title: 'ËôöÁ©∫Êµé',
            apiUrl: 'https://api2022.xukongji.com',
            articleD: {}, // ÊâÄÊúâÊï∞ÊçÆÂàóË°®
            menuList: [], // ËèúÂçïÂàóË°®
            len: 0,
            colors: ['success', 'info', 'warning', 'danger'],
            showMenu: false, // ÂàáÊç¢ÊòæÁ§∫ËèúÂçï
            wordTotal: 0, // Â≠óÊï∞
            font: [20, 22, 24, 26, 28, 30],
            fontF: [
                { n: 'ÈªòËÆ§', v: 'inherit' }, { n: 'Áõõ‰∏ñ', v: 'shengshi' },
                { n: 'Ê•∑‰Ωì', v: 'kaiti' },{ n: '‰ªäÊ•∑', v: 'jinkai' }, { n: '‰∫ëÈªë', v: 'yunhei' },
                { n: 'ÁéÑ‰∏â', v: 'xuansan' }, { n: 'Ë°åÈªë', v: 'xinghei' }, { n: 'Âç°ÈÄö', v: 'katong' }
            ],
            currFontS: 26,
            currFontF: 'inherit',
            footMenu: [{
                n: 'ËÆæÁΩÆ'
            }],
            themeL: [{ // ‰∏ªÈ¢ò
                n: 'ÈòÖËØª',
                id: 1
            }, {
                n: 'Âè§È£é',
                id: 2
            }, {
                n: 'ÁôΩÂ§©',
                id: 3
            }, {
                n: 'Â§úÊôö',
                id: 4
            }],
            theme: 1, // 1ÈªòËÆ§Ôºå1Ôºåbg1,bg2
            process: 0, // ÂΩìÂâçÈòÖËØªËøõÂ∫¶
            word: '', // ÊêúÁ¥¢ÁõÆÂΩïÂÖ≥ÈîÆÂ≠ó
            height: 0,// Â±èÂπïÁöÑÈ´òÂ∫¶
            isDark: false, // ÈªòËÆ§Á≥ªÁªü‰∏ªÈ¢ò
            isReverse: false, // ÈªòËÆ§ÁõÆÂΩïÊéíÂ∫è
            isPage: false, // ÊòØÂê¶ÂºÄÂêØÁøªÈ°µ
            currItem: '', // ÂΩìÂâçÊ†áÈ¢òÂêçÁß∞
            currIdx: '', // ÂΩìÂâçÁ¥¢Âºï
            showOpt: false, // ÊòØÂê¶ÊòæÁ§∫ËÆæÁΩÆ
            dbTime: null, // ÂèåÂáªÂçïÊú∫Êó∂Èó¥ËÆ°Êó∂Âô®
            processTime: null, // Ëé∑ÂèñÁôæÂàÜÊØîËÆ°Êó∂Âô®
            xkj_text: {}, // Êú¨Âú∞id

        },
        methods: {
            // Ëé∑Âèñhtml
            getHtml: function (url, config) {
                opt = {
                    headers: {
                        'Cache-Control': 'public,max-age=7200', //‰∏çÁºìÂ≠ò
                        'Content-Type': 'text/html; charset=UTF-8'
                    }
                }
                if (config) Object.assign(opt, config)
                return fetch(url, opt).then((res) => {
                    if (res.ok) {
                        return res.text()
                    } else {
                        if (res.status === 404) {
                            alert('ÂΩìÂâçÁΩëÈ°µÁª¥Êä§‰∏≠...ÔºåËØ∑ÁÇπÂáªÁ°ÆÂÆöÂÖ≥Èó≠')
                            window.close();
                        }
                        // ÊúçÂä°Âô®ÂºÇÂ∏∏
                        throw Error('')
                    }
                }).catch((error) => {
                    console.log('errorMessage', error)
                })
            },

            // Ë∑≥ËΩ¨Âà∞È°∂ÈÉ®
            toTop: function() {
                window.scrollTo(0,0);
            },

            // Ë£ÅÂâ™Ê†áÈ¢ò
            subTit: function (title) {
                return title.slice(0, 20)
            },

            // ËÆ°ÁÆóÊÄªÊï∞
            total: function (str, n) {
                if (n) {
                    if (n >= 1000 && n < 10000) {
                        n = n / 1000 + 'k'
                    } else if (n >= 10000) {
                        n = n / 10000 + 'w'
                    }
                    return n;
                }
                var num = 0
                for (i = 0; i < str.length; i++) {
                    s = str.charAt(i)
                    if ('\u4e00' <= s && s <= '\u9fef') {
                        num += 1;
                    }
                }
                if (num >= 1000 && num < 10000) {
                    s = num / 1000 + 'k'
                } else if (num >= 10000) {
                    s = num / 10000 + 'w'
                } else {
                    s = num
                }
                return s;
                // return {
                //     str: s,
                //     num: num
                // }
            },

            // ËÆæÁΩÆÂ≠ó‰ΩìÂ§ßÂ∞è
            setFontS: function (size) {
                if (size == '+') {
                    s = (s + 1)
                } else if (size == '-') {
                    s = (s - 1)
                } else {
                    s = size;
                }
                var dom = document.querySelector('#bodyBox');
                dom.style.fontSize = s + 'px';
                
                // Áî±‰∫éÂ≠ó‰ΩìÊîπÂèòÂêéÈ°µÈù¢È´òÂ∫¶ÂèòÂåñÔºåÈúÄË¶ÅÂª∂ËøüÈáçÊñ∞ËÆ°ÁÆóÂõûÂà∞ÂΩìÂâç‰ΩçÁΩÆ
                this.currFontS = s;
                $echo.setStorage('fontSize', this.currFontS);
            },

            // ÊòæÁ§∫ËèúÂçïÂàáÊç¢
            clickShowMenu: function () {
                this.showMenu = true;
                setTimeout(this.hideReadOpt, 200)
            },

            // ÂêëÂ∑¶ÊªëÂä®ÈöêËóèËèúÂçï
            clickHideMenu: function () {
                this.showMenu = false
            },

            // Ê∏ÖÁ©∫ËÆæÁΩÆ
            reset: function (s) {
                var is = window.confirm('ÊòØÂê¶Ê∏ÖÁ©∫Ôºü')
                if (is) {
                    if (s === 's') {
                        localStorage.removeItem('localInfo_' + type)
                        sessionStorage.clear();
                    } else if (s === 'c') {
                        INDEXDB.deleteItem(type);
                    }
                }
            },

            // ÊêúÁ¥¢ÁõÆÂΩï
            search: function () {
                this.menuList.forEach((item, id) => {
                    if ((id + 1 + '--' + item.title).indexOf(this.word) > -1) {
                        item.hide = false;
                    } else {
                        item.hide = true;
                    }
                })
            },
            // ÂõûËΩ¶
            enterSearch: function () {

            },

            // ÂàáÊç¢ÊéíÂ∫èÂÄíÂ∫è
            switchOrder: function () {
                this.isReverse = !this.isReverse
                this.menuList.reverse();
            },

            // ËÆæÁΩÆ‰∏ªÈ¢ò
            changeTheme: function (item) {
                this.theme = item.id
                $echo.setStorage('theme', this.theme);
            },

            // ËÆæÁΩÆÂ≠ó‰Ωì
            setFontF: function (item) {
                if (item) {
                    this.currFontF = item.v;
                    $echo.setStorage('font', this.currFontF);
                }
                setTimeout(() => {
                    document.body.style.fontFamily = this.currFontF
                }, 16)
            },

            // ÂºÄÂêØË∑üÈöèÁ≥ªÁªü‰∏ªÈ¢ò
            switchDark: function () {
                this.isDark = !this.isDark;
                if (this.isDark && window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    this.theme = 4;
                } else {
                    this.theme = localStorage.theme;
                }
                localStorage.setItem('isDark', this.isDark)
            },

            // ÂàáÊç¢ÁôΩÂ§©ÂíåÈªëÂ§ú
            switchTheme: function () {
                if (this.theme === 4) {
                    this.theme = 1;
                } else {
                    this.theme = 4;
                }
            },

            // ÂºÄÂêØÁøªÈ°µ
            switchPage: function () {
                this.isPage = !this.isPage;
            },

            // ÊòæÁ§∫ÈòÖËØªËÆæÁΩÆ
            showReadOpt: function (id, item) {
                clearTimeout(this.dbTime);
                // ÂèåÂáªËèúÂçïÂíåÂçïÊú∫ËèúÂçïÂÆöÊó∂Âô®
                if (this.showOpt) {
                    this.showOpt = false;
                } else {
                    this.dbTime = setTimeout(() => {
                        this.showOpt = true;
                        this.getProcess();
                    }, 250);
                }

            },

            // ÈöêËóèÈòÖËØªËÆæÁΩÆ
            hideReadOpt: function () {
                clearTimeout(this.dbTime);
                this.showOpt = false;
            },

            // Ë∑≥ËΩ¨ÊñáÁ´†
            toArticle: function (idx) {
                if(this.currIdx === idx) return false;
                var item = this.menuList[idx]
                this.currItem = item;
                this.currIdx = idx;
                this.saveText();
                this.getArticle();
            },
            // ‰∏ã‰∏ÄÁ´† // ‰∏ä‰∏ÄÁ´†
            pageNext: function (type) {
                if (type === '+') {
                    this.toArticle(this.currIdx + 1)
                } else if (type === '-') {
                    this.toArticle(this.currIdx - 1)
                }
            },

            // Ëé∑Âèñhtml
            getArticle: function () {
                var path = this.apiUrl + '/api/article/menuInfoWeb?id=' + this.currItem.id;
                this.getHtml(path, { method: "get" }).then(res => {
                    var re3 = /[\r\n\f\t]|(<\/?br\/?>)+|\sstyle=".*?"|(&nbsp;)|<strong>[\s\t\r\f\n]*<\/strong>|<span>[\s\t\r\f\n]*<\/span>|<p>[\s\t\r\f\n]*<\/p>|<div>[\s\t\r\f\n]*<\/div>/img
                    while (res.match(re3)) {
                        res = res.replace(re3, "");
                    }
                    var re_all = /<article class=\"article\">.*<\/article>/mgi;  // ÊñáÁ´†ÈÉ®ÂàÜ
                    var re_article = /<div class=\"content\">.*<\/div>/img  // Ê≠£ÊñáÈÉ®ÂàÜ
                    var re_date = /\d+-\d+-\d+(\s+\d+:\d+)?/img
                    window.scrollTo(0, 0); // Ë∑≥ËΩ¨Âà∞ÊñáÁ´†È°∂ÈÉ®
                    html = res.match(re_all)[0]
                    var date = html.match(re_date)[0]
                    html = html.match(re_article)[0] // Ê≠£Êñá
                    html = '<div class="B1_text">' + html + '</div>'
                    this.wordTotal = this.total(html);
                    
                    // ËÆæÁΩÆÂ≠óÊï∞Âà∞ÁõÆÂΩï‰∏ä
                    this.menuList[this.currIdx]['total'] = this.wordTotal;
                    var title = this.currItem.title;
                    this.articleD = { 'title': title, 'html': html, 'date': date}
                    this.$nextTick(()=>{
                        document.title = title;
                    })
                })
            },

            // ‰øùÂ≠òÊú¨Âú∞ËßÜÈ¢ë‰ΩçÁΩÆ
            saveText: function () {
                var xkj_text = localStorage.getItem('xkj_text');
                if (xkj_text) this.xkj_text = JSON.parse(xkj_text);
                this.xkj_text['t' + id] = this.currItem.id;
                localStorage.setItem('xkj_text', JSON.stringify(this.xkj_text))
            },

            // ËÆ°ÁÆóÈòÖËØªÁôæÂàÜÊØî
            getProcess: function () {
                var elH = document.documentElement.scrollHeight || document.body.scrollHeight; // ÂΩìÂâçÁ´†ËäÇÈ´òÂ∫¶
                var scrollTop = document.documentElement.scrollTop; // ÊªöÂä®È´òÂ∫¶
                var p = (scrollTop) / (elH - this.height);
                p = p >= 1 ? 1 : p;
                p = (p * 100).toFixed(2)
                if (p == 0) {
                    p = 0;
                } else if (p >= 100) {
                    p = 100;
                }
                this.process = p + '%';
            },

            getP: function() {
                clearInterval(this.processTime);
                this.processTime = setTimeout(() => {
                    this.getProcess();
                }, 600)
            },


            // Ëé∑ÂèñÂΩìÂâçÂàóË°®
            getArticleList: function () {
                var path = this.apiUrl + '/api/article/menu';
                var body = JSON.stringify({ "a_id": id });
                var opt = { method: "post", body: body };
                $echo.getJson(path, opt).then((res) => {
                    res = res['data'];
                    var xkj_text = localStorage.getItem('xkj_text');
                    if (xkj_text) this.xkj_text = JSON.parse(xkj_text);
                    var idxs = 0;
                    var re = /„Ää.*?„Äã|Ôºà.*?Ôºâ/img
                    res.forEach((item, idx) => {
                        item.title = item.title.replace(re,'');
                        item.idx = idx;
                        if (this.xkj_text['t' + id] == item.id) {
                            idxs = idx;
                        }
                    })
                    this.menuList = res;
                    this.len = res.length;
                    this.toArticle(idxs)
                })
            }
        },
        created: function () {

        },
        mounted: function () {
            this.height = window.screen.availHeight
            // Â≠ó‰Ωì
            var font = localStorage.getItem('font')
            var fontSize = localStorage.getItem('fontSize');
            if (font) { 
                this.currFontF = font;
                this.setFontF();
            }
            // Â≠óÂè∑
            if(fontSize) {
                this.setFontS(fontSize)
            }
            this.isDark = Boolean(eval($echo.getStorage('isDark'))); // ËΩ¨Êç¢Â∏ÉÂ∞îÂÄº
            if (this.isDark) { // ÊòØÂê¶ÂºÄÂêØË∑üÈöèÁ≥ªÁªü
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    this.theme = 4;
                } else {
                    this.theme = 1;
                }
            } else {
                this.theme = localStorage.getItem('theme') || 1;
            }
            this.getArticleList();
        }
    })
</script>

</html>